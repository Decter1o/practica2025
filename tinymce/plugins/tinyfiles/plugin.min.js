tinymce.PluginManager.add('tinyfiles', function(editor, url) {

	var vidgetWidth = (document.documentElement.clientWidth - 60);
	var vidgerHeight = (document.documentElement.clientHeight - 60);


	//editor.settings.file_picker_types = 'file image media';
	//editor.settings.file_picker_callback = filemanager;

	function filemanager_onMessage(event){
		if(event.data.sender === 'tinyfiles'){
			console.log(tinymce.activeEditor)
			tinymce.activeEditor.insertContent(event.data.html);
			tinymce.activeEditor.windowManager.close();
			// Remove event listener for a message from ResponsiveFilemanager
			if(window.removeEventListener){
				window.removeEventListener('message', filemanager_onMessage, false);
			} else {
				window.detachEvent('onmessage', filemanager_onMessage);
			}
		}
	}

	var openDialog = function () {

		if(window.addEventListener){
			window.addEventListener('message', filemanager_onMessage, false);
		} else {
			window.attachEvent('onmessage', filemanager_onMessage);
		}

		const fileUrl = editor.settings.filemngRoot;

		return editor.windowManager.openUrl({
			title: 'Диспетчер файлов',
			width: vidgetWidth,
			height: vidgerHeight,
			inline: 1,
			resizable: true,
			maximizable: true,
			url: fileUrl

			/*body: {
				type: 'panel',
				items: [
					{
						type: 'htmlpanel',
						html: '<div>Html goes here</div>'
					}
				]
			},*/
			/*buttons: [
				{
					type: 'cancel',
					text: 'Close'
				},
				{
					type: 'submit',
					text: 'Save',
					primary: true
				}
			],
			onSubmit: function (api) {
				var data = api.getData();
				// Insert content when the window form is submitted
				editor.insertContent('Title: ' + data.title);
				api.close();
			}*/
		});

	};
	  
	// Add a button that opens a window
	editor.ui.registry.addButton('tinyfiles', {
		icon: 'browse',
		tooltip: 'Insert file',
		shortcut: 'Ctrl+E',
		context: 'insert',
		onAction: function () {
			// Open window
			openDialog();
		}
	});

	// Adds a menu item, which can then be included in any menu via the menu/menubar configuration
	editor.ui.registry.addMenuItem('tinyfiles', {
		text: 'Example plugin',
		onAction: function() {
			// Open window
			openDialog();
		}
	});

	return {
		getMetadata: function () {
			return  {
				name: "Example plugin",
				url: "http://exampleplugindocsurl.com"
			};
		}
	};

});